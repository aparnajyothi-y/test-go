name: Repro Setup-Go Cache Issue

on:
  workflow_dispatch:

jobs:
  repro-cache:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Initialize Go project
        run: |
          mkdir large-project
          cd large-project
          go mod init large-project
          # Heavy, valid modules only
          go get github.com/aws/aws-sdk-go@v1.49.0
          go get github.com/kubernetes/client-go@v0.30.0
          go get github.com/prometheus/client_golang@v1.18.0
          go get github.com/open-telemetry/opentelemetry-go@v1.24.0
          go get github.com/hashicorp/terraform-plugin-sdk/v2@v2.33.0
          go get google.golang.org/grpc@v1.61.1
          go get github.com/apache/beam@v2.56.0+incompatible
          go mod tidy

      - name: Build to populate cache
        run: |
          cd large-project
          go build ./...

      - name: Measure cache sizes
        shell: pwsh
        run: |
          $modCache = (go env GOMODCACHE)
          $buildCache = (go env GOCACHE)
          Write-Host "Module cache: $modCache"
          Write-Host "Build cache: $buildCache"
          Write-Host "üì¶ Go module cache size: $((Get-ChildItem $modCache -Recurse | Measure-Object -Property Length -Sum).Sum / 1GB) GB"
          Write-Host "üõ†Ô∏è Go build cache size: $((Get-ChildItem $buildCache -Recurse | Measure-Object -Property Length -Sum).Sum / 1GB) GB"

      - name: Save cache manually (to confirm size)
        uses: actions/cache@v4
        with:
          path: |
            ~\go\pkg\mod
            ~\AppData\Local\go-build
          key: ${{ runner.os }}-go-modcache-repro-${{ hashFiles('**/go.sum') }}
